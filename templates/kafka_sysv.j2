### BEGIN INIT INFO
# Provides:          kafka
# Required-Start:    zookeeper
# Required-Stop:     zookeeper
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: start kafka
### END INIT INFO

set -e

PATH=/usr/bin:/usr/sbin:/bin:/sbin
DESC="kafka stream-processing software"
NAME=kafka
DAEMON=/home/{{ sansible_kafka_user }}/kafka/bin/kafka-server-start.sh
DAEMON_ARGS=/home/{{ sansible_kafka_user }}/kafka/config/server.properties
PIDFILE=/var/run/$NAME.pid
SCRIPTNAME=/etc/init.d/$NAME

[ -x "$DAEMON" ] || exit 0

[ -r /home/{{ sansible_kafka_user }}/etc/environment ] && . /home/{{ sansible_kafka_user }}/etc/environment

. /lib/lsb/init-functions
if [ -f /etc/default/rcS ]; then
  . /etc/default/rcS
fi

do_start()
{
	KAFKA_HEAP_OPTS="${KAFKA_HEAP_OPTS}" JMX_PORT="${JMX_PORT}" \
	    exec start-stop-daemon --chuid ${USER}:${GROUP}  --start --quiet \
	    --background --pidfile $PIDFILE --exec $DAEMON -- \
		$DAEMON_ARGS \
		|| return 2
}


do_stop () {
    exec start-stop-daemon --chuid ${USER}:${GROUP} --start  \
        --pidfile $PIDFILE \
        --exec /home/{{ sansible_kafka_user }}/kafka/bin/kafka-server-stop.sh
}

case "$1" in
  start)
    if [ "$VERBOSE" != no ]; then
      log_begin_msg "Starting $NAME..."
    fi
    do_start
    if [ "$VERBOSE" != no ]; then
      log_end_msg 0
    fi
  ;;

  restart)
    if [ "$VERBOSE" != no ]; then
      log_begin_msg "Restarting $NAME..."
    fi
    do_stop
    do_start
    if [ "$VERBOSE" != no ]; then
      log_end_msg 0
    fi  ;;

  stop)
    if [ "$VERBOSE" != no ]; then
      log_begin_msg "Stopping $NAME..."
    fi
    do_stop
    if [ "$VERBOSE" != no ]; then
      log_end_msg 0
    fi
  ;;

  status)
    status_of_proc java $NAME
  ;;
  *)
    log_success_msg "Usage: $SCRIPTNAME {start|stop|status|restart}"
    exit 1
    ;;
esac

exit 0
